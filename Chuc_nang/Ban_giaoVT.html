<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Biên bản bàn giao VTTB</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 10px;
            background: #f5f5f5;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        label {
            font-size: 14px;
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }
        input, select {
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #8ecae6;
            background: #e9f5f7;
            box-sizing: border-box;
            font-size: 14px;
            
        }
        input:hover, select:hover {
            background: #d9f7ff;
            border-color: #5bbce0;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #219ebc;
            box-shadow: 0 0 0 3px rgba(33,158,188,0.25);
            background: #f0fcff;
        }

        .row {
            display: flex;
            gap: 16px;
        }
        .row > div {
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table th, table td {
            border: 1px solid #ccc;
            padding: 6px;
            font-size: 13px;
            text-align: left;
        }
        table th {
            background: #eee;
        }

        #items-body input {
            background: #e0fbff;
            border: 1px solid #8ecae6;
        }
        #items-body input:hover {
            background: #d9f7ff;
        }
        #items-body input:focus {
            outline: none;
            border-color: #219ebc;
            box-shadow: 0 0 0 3px rgba(33,158,188,0.25);
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 14px;
        }
        .btn-primary {
            background: #2563eb;
            color: #fff;
        }
        .btn-secondary {
            background: #e5e7eb;
            color: #111827;
        }
        .btn-danger {
            background: #ef4444;
            color: #fff;
        }
        .btn + .btn {
            margin-left: 8px;
        }
        .item-actions {
            text-align: center;
        }
        .footer-actions {
            text-align: right;
            margin-top: 10px;
        }
        .note {
            font-size: 12px;
            color: #6b7280;
        }
    </style>

    <!-- Thư viện DOCX -->
    <script src="https://unpkg.com/pizzip@3.1.1/dist/pizzip.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.1/dist/pizzip-utils.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.49.0/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>

<h1>Biên bản bàn giao VTTB</h1>

<div class="card">
    <h2>Thông tin chung</h2>

    <div>
        <label>Địa điểm (ví dụ: Tân Bình)</label>
        <input type="text" id="dia_diem" value="Tân Bình" />
    </div>

    <div class="row">
        <div>
            <label>Ngày & giờ bàn giao</label>
            <input type="datetime-local" id="ngaygio_ban_giao" />
        </div>
    </div>

    <h3>Bên giao</h3>
    <div class="row">
        <div style="max-width: 110px;">
            <label>Xưng hô</label>
            <select id="xung_ho_ben_giao">
                <option value="Ông">Ông</option>
                <option value="Bà">Bà</option>
            </select>
        </div>
        <div>
            <label>Họ tên</label>
            <input type="text" id="ten_ben_giao" />
        </div>
        <div>
            <label>Chức vụ bên giao</label>
            <input type="text" id="chuc_vu_ben_giao" />
        </div>
    </div>

    <h3>Bên nhận</h3>
    <div class="row">
        <div style="max-width: 110px;">
            <label>Xưng hô</label>
            <select id="xung_ho_ben_nhan">
                <option value="Ông">Ông</option>
                <option value="Bà">Bà</option>
            </select>
        </div>
        <div>
            <label>Họ tên</label>
            <input type="text" id="ten_ben_nhan" />
        </div>
        <div>
            <label>Chức vụ bên nhận</label>
            <input type="text" id="chuc_vu_ben_nhan" />
        </div>
    </div>

    <div>
        <label>Tên công trình / hạng mục</label>
        <input type="text" id="ten_cong_trinh" />
    </div>
</div>

<div class="card">
    <h2>Danh sách vật tư – thiết bị</h2>
    <p class="note">Bạn có thể thêm/xoá dòng bất kỳ.</p>

    <table id="items-table">
        <thead>
            <tr>
                <th style="width: 40px;">STT</th>
                <th>Tên và qui cách</th>
                <th style="width: 80px;">Đvt</th>
                <th style="width: 100px;">Số lượng</th>
                <th>Ghi chú</th>
                <th style="width: 80px;">Xoá</th>
            </tr>
        </thead>
        <tbody id="items-body"></tbody>
    </table>

    <div class="footer-actions">
        <button type="button" class="btn btn-secondary" onclick="addItemRow()">+ Thêm dòng</button>
    </div>
</div>

<div class="card">
    <div class="footer-actions">
        <button class="btn btn-primary" onclick="generateDoc()">Tạo file Word</button>
    </div>
    <p class="note">
        Bấm vào nút <b>Tạo file Word </b>để xuất ra file <b>Bàn giao VTTB </b>.
    </p>
</div>

<script>
    function addItemRow(defaultData = {}) {
        const tbody = document.getElementById("items-body");
        const stt = tbody.querySelectorAll("tr").length + 1;

        const tr = document.createElement("tr");
        tr.classList.add("item-row");

        tr.innerHTML = `
            <td class="stt-cell">${stt}</td>
            <td><input type="text" class="item-ten-quy-cach" value="${defaultData.ten_quy_cach || ""}"></td>
            <td><input type="text" class="item-dvt" value="${defaultData.dvt || ""}"></td>
            <td><input type="number" class="item-so-luong" value="${defaultData.so_luong || ""}"></td>
            <td><input type="text" class="item-ghi-chu" value="${defaultData.ghi_chu || ""}"></td>
            <td class="item-actions">
                <button type="button" class="btn btn-danger" onclick="removeItemRow(this)">Xoá</button>
            </td>
        `;

        tbody.appendChild(tr);
    }

    function removeItemRow(btn) {
        btn.closest("tr").remove();
        updateSTT();
    }

    function updateSTT() {
        const rows = document.querySelectorAll("#items-body tr");
        rows.forEach((r, i) => {
            r.querySelector(".stt-cell").textContent = i + 1;
        });
    }

    // Khởi tạo sẵn 2 dòng
    addItemRow();
    addItemRow();

    // Gán datetime hiện tại
    window.addEventListener("DOMContentLoaded", () => {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2,"0");
        const dd = String(now.getDate()).padStart(2,"0");
        const hh = String(now.getHours()).padStart(2,"0");
        const mi = String(now.getMinutes()).padStart(2,"0");

        document.getElementById("ngaygio_ban_giao").value =
            `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    });

    function loadFile(url, callback) {
        PizZipUtils.getBinaryContent(url, function(error, content) {
            if (error) return alert("Không đọc được file template.");
            callback(content);
        });
    }

    function generateDoc() {
        // Xử lý datetime-local
        let ngay="", thang="", nam="", gio_phut="", ngay_giao_dich="";

        const dtVal = document.getElementById("ngaygio_ban_giao").value;
        if (dtVal) {
            const [datePart, timePart] = dtVal.split("T");
            const [y,m,d] = datePart.split("-");
            nam = y; thang = m; ngay = d;
            ngay_giao_dich = `${d}/${m}/${y}`;

            const [hh,mi] = timePart.split(":");
            gio_phut = `${hh}h${mi}`;
        }

        const data = {
            dia_diem: document.getElementById("dia_diem").value,
            ngay, thang, nam,
            gio_phut,
            ngay_giao_dich,
            xung_ho_ben_giao: document.getElementById("xung_ho_ben_giao").value,
            ten_ben_giao: document.getElementById("ten_ben_giao").value,
            chuc_vu_ben_giao: document.getElementById("chuc_vu_ben_giao").value,
            xung_ho_ben_nhan: document.getElementById("xung_ho_ben_nhan").value,
            ten_ben_nhan: document.getElementById("ten_ben_nhan").value,
            chuc_vu_ben_nhan: document.getElementById("chuc_vu_ben_nhan").value,
            ten_cong_trinh: document.getElementById("ten_cong_trinh").value,
            items: Array.from(document.querySelectorAll("#items-body tr")).map((row,i)=>({
                stt: i+1,
                ten_quy_cach: row.querySelector(".item-ten-quy-cach").value,
                dvt: row.querySelector(".item-dvt").value,
                so_luong: row.querySelector(".item-so-luong").value,
                ghi_chu: row.querySelector(".item-ghi-chu").value
            }))
        };

        loadFile("template/BienBanGiaoVTTB_Template.docx", function(content) {
            const zip = new PizZip(content);
            const doc = new window.docxtemplater(zip, {
                paragraphLoop: true,
                linebreaks: true,
                delimiters: { start: "{", end: "}" }
            });

            doc.setData(data);

            try { doc.render(); }
            catch(e) { alert("Lỗi render. Kiểm tra tag trong Word."); return; }

            const out = doc.getZip().generate({
                type: "blob",
                mimeType:
                    "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            });

            saveAs(out, "Bien-ban-giao-VTTB.docx");
        });
    }
</script>

</body>
</html>
